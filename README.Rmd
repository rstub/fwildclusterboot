---
output: github_document
editor_options: 
  chunk_output_type: console
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# fwildclusterboot

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![CRAN status](https://www.r-pkg.org/badges/version/fwildclusterboot)](https://CRAN.R-project.org/package=fwildclusterboot)
<!-- badges: end -->

The `fwildclusterboot` package is an R port of Stata's `boottest` package. 

It implements the fast wild cluster bootstrap algorithm developed in Roodman et al (2019) for regression objects in R. It currently works for regression objects of type `lm`, `felm` and `fixest` from base R and the `lfe` and `fixest` packages. 

The package's central function is `boottest()`. It allows the user to test two-sided, univariate hypotheses using a wild cluster bootstrap. Importantly, it uses the "fast" algorithm developed in Roodman et al, which makes it feasible to calculate test statistics based on a large number of bootstrap draws even for large samples--as long as the number of bootstrapping clusters is not too large.

The `fwildclusterboot` package currently supports one- and two-dimensional clustering and one-dimensional hypotheses.

The package is highly experimental and only includes few unit tests.

The following features will be added in the future: 

* support for multivariate hypotheses 
* bootstrap distributions beyond the rademacher distribution


```{r, echo=FALSE, include=FALSE, results="hide"}
 # setwd("C:/Users/alexa/Dropbox")
 # devtools::install("fwildclusterboot")
 # devtools::document("fwildclusterboot")
#usethis::use_vignette("C:/Users/alexa/Dropbox/fwildclusterboot/my-vignette")
# devtools::test("C:/Users/alexa/Dropbox/fwildclusterboot")
# devtools::check("fwildclusterboot")
# usethis::use_vignette("my-vignette")


# 
#  library(usethis)
#  setwd("C:/Users/au563468/Dropbox/fwildclusterboot")
#  use_package("fixest", type = "Imports")
#  use_package("estimatr", type = "Imports")
# usethis::use_vignette("C:/Users/au563468/Dropbox/fwildclusterboot/vignette")




# execute all functions in fwildclusterboot 
# setwd("C:/Users/alexa/Dropbox/fwildclusterboot/R")
# file.sources = list.files(pattern="*.R")
# sapply(file.sources, source, .GlobalEnv)

# library(data.table)
```

## The `boottest()` function 

In a first step, simulate a data set with 10000 individual observations that are grouped in 50 clusters and with a small intra-cluster correlation of 0.01. The small intra-cluster correlation implies that, in theory, inference based on cluster-robust covariance estimates should lead to results that are very similar to the bootstrap. 

```{r, warning = FALSE, message=FALSE}
library(fwildclusterboot)

B <- 10000
seed <- 942413
set.seed(seed)
voters <- create_data_2(N = 10000, N_G1 = 20, icc1 = 0.01, N_G2 = 40, icc2 = 0.01, numb_fe1 = 10, numb_fe2 = 10, seed = seed)
```

The `fwildclusterboot` package supports estimation of linear models based on 
- `lm()` from `base` R
- `felm()` from `lfe`
- `feols()` from `fixest`

```{r, warning = FALSE, message = FALSE}
lm_fit <- lm(proposition_vote ~ treatment + ideology1 + log_income + Q1_immigration , weights = NULL, data = voters)
```

The `boottest` function always calculates p-values for a given univariate hypothesis test.
Second and by default, the boottest function calculates confidence intervals by inversion of the p-value. The user can considerably speed up the inference procedure by setting the argument `conf_int = FALSE`, in which case no confidence intervals are computed.

```{r, warning = FALSE, message=FALSE}
# 1) boottest based on object of class lm
boot_lm = boottest(lm_fit, clustid = "group_id1", B = B, seed = seed, param = "treatment", conf_int = TRUE)
```

The function `summarize_boot` collects the results. 
Boottest further comes with a `tidy` method which, in analogy with the `broom` package, returns the estimation results as a data.frame.

```{r, warning = FALSE, message=FALSE}
summarize_boot(boot_lm)
tidy(boot_lm)
```


```{r, include = FALSE}
boot_lm_5 = boottest(lm_fit, clustid = "group_id1", B = B, seed = seed, param = "treatment", conf_int = TRUE, beta = 0, alpha = 0.05)

boot_lm_20 = boottest(lm_fit, clustid = "group_id1", B = B, seed = seed, param = "treatment", conf_int = TRUE, beta = 0, alpha = 0.20)

summarize_boot(boot_lm_5)
summarize_boot(boot_lm_20)

#confint(feols_fit, "treatment", level = 0.95, se = "cluster", cluster = "group_id1")
#confint(feols_fit, "treatment", level = 0.80, se = "cluster", cluster = "group_id1")

```

```{r, out.width="50%", include = FALSE}
plot_boot(boot_lm)
```


## Installation

You can install the released version of `fwildclusterboot` from github by running 

```{r}
library(devtools)
#install_github("al_fisc/fwildclusterboot")
```


```{r, warning = FALSE, message=FALSE, include = FALSE}

## Comparison to `vcovBS()` from `sandwich`

#The `multiwayvcov` package offers an alternative implementation of the wild bootstrap. 
#As can be seen, `sandwich::vcovBS`, `sandwich::vcov` and `boottest()` produce similar #results: 
  
library(sandwich)
library(lmtest)

res <- vcovBS(lm_fit, cluster = ~ group_id1, parallel = FALSE, R = 1000, wild_type = "rademacher")

# 1) asymptotic sandwich standard errors 
vocv <- vcovCL(lm_fit, ~ group_id1)
head(coeftest(lm_fit, vcov))

# 1) results from sandwich's cluster bootstrap 
head(coeftest(lm_fit, res))

# 2) results from fwildclusterboot
summarize_boot(boot_lm)



```



```{r, include = FALSE}
## Some Tests with 2-way clustering 

library(sandwich)
library(lmtest)
rm(boot_lm); rm(boot_fixest); rm(boot_felm); rm(res)


boot_lm <-  boottest(lm_fit, clustid = c("group_id1", "group_id2"), B = 1000, seed = seed, param = "treatment", conf_int = FALSE)

summarize_boot(boot_lm)

vocv <- vcovCL(lm_fit, ~ group_id1 + group_id2)
coeftest(lm_fit, vcov)

vcovBS <- vcovBS(lm_fit, cluster = ~ group_id1, parallel = FALSE, R = 1000, wild_type = "rademacher")

head(coeftest(lm_fit, vcovBS))

```



## Benchmarks

Results of timing benchmarks of `fwildclusterboot` with `sandwich::vcovBS`. 

* Experiment 1: N = 10000, B = 10000, one cluster with N_G = 20
* Experiment 2: N = 10000, B = 10000, one cluster with N_G = 60

![Benchmarks.](C:/Users/alexa/Dropbox/fwildclusterboot/benchmarks/bench_boottest.png){#id .class width=70% height=70%}