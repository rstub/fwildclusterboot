---
output: github_document
editor_options: 
  chunk_output_type: console
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# fwildclusterboot

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![CRAN status](https://www.r-pkg.org/badges/version/fwildclusterboot)](https://CRAN.R-project.org/package=fwildclusterboot)
[![R-CMD-check](https://github.com/s3alfisc/fwildclusterboot/workflows/R-CMD-check/badge.svg)](https://github.com/s3alfisc/fwildclusterboot/actions)
<!-- badges: end -->

The `fwildclusterboot` package is an R port of Stata's `boottest` package. 

It implements the fast wild cluster bootstrap algorithm developed in Roodman et al (2019) for regression objects in R. It currently works for regression objects of type `lm`, `felm` and `fixest` from base R and the `lfe` and `fixest` packages. 

The package's central function is `boottest()`. It allows the user to test two-sided, univariate hypotheses using a wild cluster bootstrap. Importantly, it uses the "fast" algorithm developed in Roodman et al, which makes it feasible to calculate test statistics based on a large number of bootstrap draws even for large samples--as long as the number of bootstrapping clusters is not too large.

The `fwildclusterboot` package currently supports one- and two-dimensional clustering and one-dimensional hypotheses.

The package is currently in an experimental testing phase and still lacks sufficient unit tests.

<!-- The following features will be added in the future:  -->

<!-- * support for multivariate hypotheses  -->
<!-- * bootstrap distributions beyond the rademacher distribution -->


```{r, echo=FALSE, include=FALSE, results="hide", execute = FALSE}
# setwd("C:/Users/alexa/Dropbox")
# devtools::install("fwildclusterboot")
# devtools::document("fwildclusterboot")
# devtools::test("C:/Users/alexa/Dropbox/fwildclusterboot")
# usethis::use_github_actions()
# usethis::use_github_action(“render-readme.yaml”)
#usethis::use_github_actions_badge(name = "R-CMD-check", repo_spec = NULL)#

# usethis::use_mit_license("C:/Users/alexa/Dropbox/fwildclusterboot")
# # # cmd check r 
# # Sys.setenv('_R_CHECK_SYSTEM_CLOCK_' = 0)
# # #system("defaults write org.R-project.R force.LANG en_US.UTF-8") # restart R
# # Sys.getlocale()
# # Sys.setlocale("LC_MESSAGES", "C")
# # #Sys.setenv(LANG = "en_US.UTF-8")
# Sys.getlocale()

# # install
# setwd("C:/Users/alexa/Dropbox")
# devtools::install("fwildclusterboot")
# devtools::document("fwildclusterboot")
# devtools::test("C:/Users/alexa/Dropbox/fwildclusterboot")
# devtools::test("C:/Users/alexa/Dropbox/fwildclusterboot")
# devtools::check("C:/Users/alexa/Dropbox/fwildclusterboot")



# execute all functions in fwildclusterboot 
# setwd("C:/Users/alexa/Dropbox/fwildclusterboot/R")
# file.sources = list.files(pattern="*.R")
# sapply(file.sources, source, .GlobalEnv)

```


## Benchmarks

Results of timing benchmarks of `fwildclusterboot` with `sandwich::vcovBS` (one replication):

* Benchmark 1: one cluster with dimension $N_G = 40$
* Benchmark 2: two closters with dimensions $N_G1= 40$, $N_G2 = 20$, $N_G12 = 800$

```{r,echo=FALSE, warning = FALSE, message = FALSE}

benchmarks <- readRDS("C:/Users/alexa/Dropbox/fwildclusterboot develop/benchmarks.rds")
library(data.table)

setDT(benchmarks)

benchmarks[benchmarks$test == "fwc_1", test := "boottest, no fixed effect"]
benchmarks[benchmarks$test == "fwc_2", test := "boottest, fixed effect"]
benchmarks[benchmarks$test == "sw_1c",test :="sandwich, 1 core"]
benchmarks[benchmarks$test == "sw_2c",test :="sandwich, 2 cores"]
benchmarks[benchmarks$test == "sw_4c",test := "sandwich, 4 cores"]


library(ggplot2)
library(scales)
plot <- 
ggplot(aes(x = B, y = elapsed, group = test, color = test), data = benchmarks) + 
  facet_wrap(~ test_nr, nrow = 2) + 
  scale_y_continuous(trans = 'log10', labels = comma) + 
  geom_point() + 
  geom_line(alpha = 0.5) + 
  xlab("Number of Bootstrap Iterations") + 
  ylab("Time in seconds, log scale") + 
  theme_bw() +
  theme(legend.title=element_blank())
  #theme(legend.position="bottom")  
plot

```

## The `boottest` function 


The `fwildclusterboot` package supports wild cluster bootstrap inference for linear models based on 

- `lm()` from `base` R
- `felm()` from `lfe`
- `feols()` from `fixest`

```{r, warning = FALSE, message = FALSE}
library(fwildclusterboot)

B <- 10000
seed <- 942413
set.seed(seed)
voters <- create_data_2(N = 10000, N_G1 = 20, icc1 = 0.01, N_G2 = 10, icc2 = 0.01, numb_fe1 = 10, numb_fe2 = 10, seed = seed)

# estimate the regression model
lm_fit <- lm(proposition_vote ~ treatment + ideology1 + log_income + Q1_immigration , weights = NULL, data = voters)

# bootstrap estimation
boot_lm = boottest(lm_fit, clustid = "group_id1", B = B, seed = seed, param = "treatment", conf_int = TRUE)

# summarize the results
summary(boot_lm)
tidy(boot_lm)

```

<!-- The `boottest` function always calculates p-values for a given univariate hypothesis test. -->
<!-- Second and by default, the boottest function calculates confidence intervals by inversion of the p-value. The user can considerably speed up the inference procedure by setting the argument `conf_int = FALSE`, in which case no confidence intervals are computed. -->

<!-- ```{r, warning = FALSE, message=FALSE} -->
<!-- # 1) boottest based on object of class lm -->
<!-- boot_lm = boottest(lm_fit, clustid = "group_id1", B = B, seed = seed, param = "treatment", conf_int = TRUE) -->
<!-- ``` -->

<!-- The function `summary` collects the results.  -->
<!-- Boottest further comes with a `tidy` method, which, in analogy with the `broom` package, returns the estimation results as a data.frame. -->

<!-- ```{r, warning = FALSE, message=FALSE} -->
<!-- summary(boot_lm) -->
<!-- tidy(boot_lm) -->
<!-- ``` -->


```{r, include = FALSE}
boot_lm_5 = boottest(lm_fit, clustid = "group_id1", B = B, seed = seed, param = "treatment", conf_int = TRUE, beta = 0, alpha = 0.05)

boot_lm_20 = boottest(lm_fit, clustid = "group_id1", B = B, seed = seed, param = "treatment", conf_int = TRUE, beta = 0, alpha = 0.20)

summary(boot_lm_5)
summary(boot_lm_20)

#confint(feols_fit, "treatment", level = 0.95, se = "cluster", cluster = "group_id1")
#confint(feols_fit, "treatment", level = 0.80, se = "cluster", cluster = "group_id1")

```

```{r, out.width="50%", include = FALSE}
plot(boot_lm)
```


## Installation

You can install the development version of `fwildclusterboot` from github by following the steps below. The installation process is currently complicated by the fact that a package dependency, the `collapse` package, has been temporarily removed from cran. Once `collapse` is back on cran, the last line will suffice. 

```{r, eval = FALSE}
# 1) install the most recent version of devtools
install.packages("devtools")
# 2) restart your r session
# 3) install Rtools if not already installed
# 4) install the package
devtools::install_github("s3alfisc/fwildclusterboot")
```



