---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# fwildclusterboot

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![CRAN status](https://www.r-pkg.org/badges/version/fwildclusterboot)](https://CRAN.R-project.org/package=fwildclusterboot)
<!-- badges: end -->

The `fwildclusterboot` package is an R port to Stata's `boottest` package. 

It implements the fast wild cluster bootstrap algorithm developed in Roodman et al for regression objects in R. It currently works for regression objects of type `lm`, `felm` and `fixest` from the base R and the `lfe` and `fixest` packages. 

The package's central function is `boottest()`. It allows the user to test two-sided, univariate hypotheses using a wild cluster bootstrap. Importantly, it uses the "fast" algorithm developed in Roodman et al, which makes it feasible to calculate test statistics based on a large number of bootstrap draws even for large samples. 

The `fwildclusterboot` package currently only supports one-dimensional clustering and one-dimensional hypotheses, but allows for an arbitrary number of fixed effects. 

The package is highly experimental and currently does not include any unit tests.

## Installation

You can install the released version of `fwildclusterboot` from github by running 

```{r}
library(devtools)
#install_github("al_fisc/fwildclusterboot")
```




```{r, echo=FALSE, include=FALSE, results="hide"}

# setwd("C:/Users/alexa/Dropbox")
# devtools::install("fwildclusterboot")
# devtools::check("fwildclusterboot")
# devtools::document("fwildclusterboot")
 # # 
#  library(usethis)
#  setwd("C:/Users/au563468/Dropbox/fwildclusterboot")
#  use_package("data.table", type = "Imports")
#use_package("estimatr", type = "Imports")



# execute all functions in fwildclusterboot 
setwd("C:/Users/alexa/Dropbox/fwildclusterboot/R")
file.sources = list.files(pattern="*.R")
sapply(file.sources, source, .GlobalEnv)

library(data.table)
```

## The boottest function 
In a first step, simulate a data set with 10000 individual observations that are grouped in 20 clusters and with a small intra-cluster correlation of 0.01. The small intra-cluster correlation implies that, in theory, inference based on cluster-robust covariance estimates should lead to results that are very similar to the bootstrap. 

```{r, warning = FALSE, message=FALSE}
library(lfe)
library(fixest)

library(fwildclusterboot)
B <- 1000
seed <- 421
set.seed(seed)
voters <- create_data_1(N = 10000, N_G = 20, icc = 0.01)
head(voters)

```

The `fwildclusterboot` package supports estimation of linear models based on 
- `lm()` from `base` R
- `felm()` from `lfe`
- `feols()` from `fixest`

```{r}
# 1) boottest based on object of class lm
lm_fit <- lm(proposition_vote ~ treatment + ideology + log_income + Q1_immigration , weights = NULL, data = voters)

# 2) boottest based on object of class fixest
feols_fit <- feols(proposition_vote ~ treatment + ideology + log_income , fixef = c("Q1_immigration"), weights = NULL, data = voters)
feols_fit1 <- feols(proposition_vote ~ treatment + ideology + log_income + Q1_immigration, weights = NULL, data = voters)
feols_fit2 <- feols(proposition_vote ~ treatment + ideology + log_income + as.factor(Q1_immigration), weights = NULL, data = voters)

# 3) bootest based on object of class felm
felm_fit <- felm(proposition_vote ~ treatment + ideology + log_income | Q1_immigration, weights = NULL, data = voters)
felm_fit1 <- felm(proposition_vote ~ treatment + ideology + log_income + Q1_immigration, weights = NULL, data = voters)
```

The `boottest` command offers two options First, it always calculates p-values for a given univariate hypothesis test.
Second and by default, the boottest function calculates confidence intervals by inversion of the p-value. The user can considerably speed up the inference procedure by setting the argument `conf_int = FALSE`, in which case no confidence intervals are computed.

```{r, include = FALSE, warning = FALSE, echo = FALSE}
# 1) boottest based on object of class lm
boot_lm = boottest(lm_fit, clustid = voters$group_id, B = B, seed = seed, param = "treatment", conf_int = FALSE)

# 2) bootest based on object of class feols
boot_fixest = boottest(feols_fit, clustid = voters$group_id, B = B, seed = seed, param = "treatment", conf_int = FALSE)
boot_fixest1 = boottest(feols_fit1, clustid = voters$group_id, B = B, seed = seed, param = "treatment", conf_int = FALSE, beta = 0)
# boot_fixest2 = boottest(feols_fit2, clustid = voters$group_id, B = B, seed = seed, param = "treatment", conf_int = FALSE, beta = 0)

# 3) boottest based on object of class felm
boot_felm = boottest(felm_fit, clustid = voters$group_id, B = B, seed = seed, param = "treatment", conf_int = FALSE)
boot_felm1 = boottest(felm_fit1, clustid = voters$group_id, B = B, seed = seed, param = "treatment", conf_int = FALSE)
```

```{r}
# 1) boottest based on object of class lm
boot_lm = boottest(lm_fit, clustid = voters$group_id, B = B, seed = seed, param = "treatment", conf_int = TRUE)

# 2) bootest based on object of class feols
boot_fixest = boottest(feols_fit, clustid = voters$group_id, B = B, seed = seed, param = "treatment", conf_int = TRUE)
boot_fixest1 = boottest(feols_fit1, clustid = voters$group_id, B = B, seed = seed, param = "treatment", conf_int = TRUE, beta = 0)
# boot_fixest2 = boottest(feols_fit2, clustid = voters$group_id, B = B, seed = seed, param = "treatment", conf_int = TRUE, beta = 0)

# 3) boottest based on object of class felm
boot_felm = boottest(felm_fit, clustid = voters$group_id, B = B, seed = seed, param = "treatment", conf_int = TRUE)
boot_felm1 = boottest(felm_fit1, clustid = voters$group_id, B = B, seed = seed, param = "treatment", conf_int = TRUE)
```

A `summary` method collects the results. 

```{r}
summary(boot_lm)
summary(boot_felm)
summary(boot_felm1)
summary(boot_fixest)
summary(boot_fixest1)
```


These estimates are very close to estimates using sandwich cluster robust estimators:

```{r}
fixest:::summary.fixest(feols_fit, se = "cluster", cluster = "group_id")

```

Boottest further comes with a `tidy` method which, in analogy with the `broom` package, returns the estimation results as a data.frame.

```{r}
tidy(boot_lm)
tidy(boot_felm)
tidy(boot_fixest)

```

## Comparison to cluster.boot()

```{r}
library(multiwayvcov)
library(lmtest)
res <- cluster.boot(lm_fit, cluster = voters$group_id, parallel = TRUE, R = 10000, wild_type = "rademacher")
coeftest(lm_fit, res)
summary(boottest(lm_fit, B = 20000, clustid = voters$group_id, param = "treatment"))
fixest:::summary.fixest(feols_fit, se = "cluster", cluster = "group_id")


```
